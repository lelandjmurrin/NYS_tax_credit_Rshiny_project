---
title: "R Notebook"
output: html_notebook
---

Call Libraries
```{r} 
library(tidyverse)
library(caret)
library(MASS)
```

Load Datasets
```{r}
NYS_tax_credit_used <- read_csv('NYS_Corp_Tax_Credit_data/NYS_tax_credit_used.csv')
NYS_tax_credit_net_income <- read_csv('NYS_Corp_Tax_Credit_data/NYS_tax_credit_net_income.csv')
NYS_tax_credit_taxation_basis <- read_csv('NYS_Corp_Tax_Credit_data/NYS_tax_credit_taxation_basis.csv')
NYS_tax_credit_industry <- read_csv('NYS_Corp_Tax_Credit_data/NYS_tax_credit_industry.csv')
```
Cleaning up Credit
```{r}
NYS_tax_credit_industry %>% select(`Credit Name`) %>% distinct() %>% arrange(`Credit Name`)
NYS_tax_credit_net_income %>% select(`Credit Name`) %>% distinct() %>% arrange(`Credit Name`)

NYS_tax_credit_net_income %>% mutate(`Credit Name` = ifelse(str_starts(`Credit Name`, 'Alcoholic'), 'Alcoholic Beverage Production Credit', `Credit Name`), `Credit Name` = ifelse(str_starts(`Credit Name`, 'Manufacture'), 'Real Property Tax Relief Credit for Manufacturing', `Credit Name`)) %>% select(`Credit Name`) %>% distinct() %>% arrange(`Credit Name`) #Next Time
```

Cleaning the Datasets
```{r}
colnames(NYS_tax_credit_net_income)[5] <- 'Group'

colnames(NYS_tax_credit_industry)[5] <- 'Group'

filter_total_func <- function (df) {
  return (df %>% 
            filter(Group == 'Total', 
                   `Credit Type` == 'Credit Earned') %>% 
            select(Year = `Tax Year`, 
                   Name = `Credit Name`, 
                   Num = `Number of Taxpayers`, 
                   Amount = `Amount of Credit`))
}

#Net Income Group Dataset
net_income_earned_total <- NYS_tax_credit_net_income %>% filter_total_func()
net_income_earned_total

#Industry Group Dataset
industry_earned_total <- NYS_tax_credit_industry %>% filter_total_func()
industry_earned_total
```

```{r}
filter_group_func <- function (df) {
  return (df %>% 
            filter(Group != 'Total', 
                   `Credit Type` == 'Credit Earned') %>% 
            select(Year = `Tax Year`, 
                   Name = `Credit Name`, 
                   Group, 
                   Num = `Number of Taxpayers`, 
                   Amount = `Amount of Credit`))
}

#Net Income Group Dataset
net_income_earned <- NYS_tax_credit_net_income %>% filter_group_func()
net_income_earned

#Industry Group Dataset
industry_earned <- NYS_tax_credit_industry %>% filter_group_func()
industry_earned
```

Joining datasets, Filtering and Imputing missing values
```{r}
nasum <- function (x) {
  return (sum(is.na(x)))
}

join_total_func <- function(df_e, df_t) {
          return(inner_join(df_e, 
                             df_t, 
                             by = c('Year', 'Name'), 
                             suffix = c('_e', '_t')) %>% 
                  #filter out all year/name combos that have total taxpayers equal to 0 or NA.
                  filter(!is.na(Num_t),
                          Num_t != 0) %>% 
                  group_by(Year, Name) %>% 
                  #Taking difference between reported total num of taxpayers (Num_t) and expected num of taxpayers (Num_e). 
                  #Distributing this evenly accross the NAs in expected num of taxpayers. The same is done for the Amount of Credit.
                  mutate(impute_num = (Num_t-sum(Num_e, na.rm = T))/nasum(Num_e), 
                          impute_amt = (Amount_t-sum(Amount_e, na.rm = T))/nasum(Amount_e)) %>%
                  mutate(Num_e = ifelse(is.na(Num_e), impute_num, Num_e), 
                          Amount_e = ifelse(is.na(Amount_e), impute_amt, Amount_e)) %>% #Imputing here.
                  select(Year, 
                         Name, 
                         Group, 
                         Num = Num_e, 
                         Amount = Amount_e) %>%
                  filter(Num != 0) %>%
                  mutate(Avg = Amount/Num) %>% #Calculated the average amount of credit earned per taxpayer (Avg) and being careful not to divide by 0.
                  ungroup()
         )
}

#Net Income Group Dataset cleaned
income_cleaned <- join_total_func(net_income_earned, net_income_earned_total)

#Industry Group Dataset cleaned
industry_cleaned <- join_total_func(industry_earned, industry_earned_total)
```

Writing the final cleaned dataset to a csv file for ensuing regression analysis
```{r}
write_csv(industry_cleaned, 'NYS_Corp_Tax_Credit_data/industry_cleaned.csv')
write_csv(income_cleaned, 'NYS_Corp_Tax_Credit_data/income_cleaned.csv')
```




