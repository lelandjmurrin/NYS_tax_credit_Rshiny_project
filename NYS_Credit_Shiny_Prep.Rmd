---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
```

Calling the Transformed Datasets
```{r}
income_cleaned = read_csv('Shiny_app/data/income_cleaned.csv')
industry_cleaned = read_csv('Shiny_app/data/industry_cleaned.csv')
```

```{r}
clean_colname <- function(cols) {
  return(str_replace_all(cols, "[-'/ ,�&()`]", '_'))
}
```



Creating key dataframe for changes between user input colnames and dummy dataset colnames
```{r}
#Income
as.data.frame(colnames(income.dummy.bc))

income_name_key_df <- income_cleaned %>% select(col = Name) %>% distinct() %>% mutate(dummy_col = paste0('Name', clean_colname(col)))
income_name_key_df

income_group_key_df <- income_cleaned %>% select(col = Group) %>% distinct() %>% mutate(dummy_col = paste0('Group', clean_colname(col)))

income_key_df <- rbind(income_name_key_df, income_group_key_df, c('Year', 'Year'), c('Num', 'Num')) %>% mutate(dataset = 'income')
income_key_df

#SHINY USER LOGIC
# user_input_df <- key_df %>% mutate(value = 0)
# 
# user_input_df <- user_input_df %>% mutate(value = ifelse(col == 'Alcoholic Beverage Production Credit', 1, value), value = ifelse(col == 'Year', 2019, value)) %>% select(-col) %>% pivot_wider(names_from = dummy_col, values_from = value)
# 
# predict(forwardBIC[['income']], newdata = user_input_df)
```

```{r}
#Industry
as.data.frame(colnames(industry.dummy.bc))
industry_cleaned %>% select(Group) %>% distinct()
industry_name_key_df <- industry_cleaned %>% select(col = Name) %>% distinct() %>% mutate(dummy_col = paste0('Name', clean_colname(col)))
industry_name_key_df

industry_group_key_df <- industry_cleaned %>% select(col = Group) %>% distinct() %>% mutate(dummy_col = paste0('Group', clean_colname(col)))

industry_key_df <- rbind(industry_name_key_df, industry_group_key_df, c('Year', 'Year'), c('Num', 'Num')) %>% mutate(dataset = 'industry')
industry_key_df
```

```{r}
#Combining colname key dataframes for Industry and Income and writing to csv
user_input_key <- rbind(income_key_df, industry_key_df) %>% mutate(value = 0)

user_input_key %>% write_csv('Shiny_app/data/user_input_key.csv')
```


```{r}
user_input_key %>% filter(dataset == 'income', str_starts(dummy_col, 'Group')) %>% select(col) %>% arrange(col) %>% as.vector() %>% dplyr::first()
```


------------------------------------------------------------------------------------------------------------------------------------------------------------------
                Code for user input for making predictions and plotting predictions visualizations
------------------------------------------------------------------------------------------------------------------------------------------------------------------
```{r}
user_input_key <- read_csv('Shiny_app/data/user_input_key.csv')
best.saved.model <- readRDS('Shiny_app/data/best_models.rds')
lambda.bcs <- readRDS('Shiny_app/data/lambda.bcs.rds')
```

```{r}
#Income


#simulating inputs for Rshiny app
user_input_df_updated <- user_input_key %>% filter(dataset == 'income') %>% mutate(value = ifelse(col == 'Alcoholic Beverage Production Credit', as.numeric('1'), value), value = ifelse(col == 'Year', as.numeric('2019'), value), value = ifelse(col == '$1 - $99,999', as.numeric('1'), value)) %>% select(-col, -dataset) %>% pivot_wider(names_from = dummy_col, values_from = value)

user_input_df_updated <- user_input_df_updated[rep(1,5),] %>% mutate(Num = c(1,50,100,200,500))

#checking the inputs were correctly added
user_input_df_updated %>% select(NameAlcoholic_Beverage_Production_Credit, Year, Num, `Group$1___$99_999`)
?seq()
```


```{r}
boxcox_to_dollars <- function(x, dataset){
  (x*lambda.bcs[[dataset]]+1)^(1/lambda.bcs[[dataset]])
}


user_input_pred <- predict(best.saved.model[['income']], newdata = user_input_df_updated, interval = 'confidence')

user_input_pred_final <- as.data.frame(user_input_pred) %>% mutate(fit_dollars = boxcox_to_dollars(fit, 'income'), lwr_dollars = boxcox_to_dollars(lwr, 'income'), upr_dollars = boxcox_to_dollars(upr, 'income')) %>% mutate(Num = user_input_df_updated$Num) 

#user_input_pred_final %>% ggplot(aes(Num, fit_dollars)) + geom_point() + geom_errorbar(aes(ymin = lwr_dollars, ymax = upr_dollars)) + geom_smooth()
user_input_pred_final
user_input_pred_final %>% ggplot(aes(Num, fit_dollars)) + geom_ribbon(aes(ymin = lwr_dollars, ymax = upr_dollars), fill = 'grey70') + geom_point() + geom_errorbar(aes(ymin = lwr_dollars, ymax = upr_dollars)) + geom_line() + labs(x = 'Number of Taxpayers', y = 'Avg Credit Earned per Taxpayer ($)', title = paste0('PREDICTIONS', '\nCredit: ', 'Alcoholic Beverage Production Credit', '\nYear: ', '2019, ', 'Group: ', '1$ - $99,999'))

```


```{r}
c(1, seq(25, 500, by = 25))
```



Number of taxpayers per Group for a given Credit Name and Income/Industry Group input (Inputs in the filter)
```{r}
#Income
income_cleaned %>% filter(Year > 2016, Name == 'Alcoholic Beverage Production Credit', Group == '$1 - $99,999') %>% group_by(Name, Year, Group) %>% summarise(Num = sum(Num)) %>% arrange(desc(Num))

income_cleaned %>% select(Group)
user_input_key %>% filter(dataset == 'income', 
                          str_starts(dummy_col, 'Group')) %>% 
                          select(col) %>%
                          mutate(col = c('Zero or Net Loss', 
                                         '$1 - $99,999', 
                                         '100,000 - 499,999', 
                                         '500,000 - 999,999', 
                                         '1,000,000 - 24,999,999', 
                                         '25,000,000 - 49,999,999', 
                                         '50,000,000 - 99,999,999', 
                                         '100,000,000 - 499,999,999',
                                         '500,000,000 - and over')) %>%
                          as.vector() %>%
                          dplyr::first()


```

```{r}
#Industry
industry_cleaned %>% filter(Name == 'Investment Tax Credit', Group == 'Manufacturing') %>% group_by(Name, Year, Group) %>% summarise(Num = sum(Num)) %>% arrange(desc(Year)) %>% head(5)

```

```{r}
income_cleaned %>% filter(Year == 2019) %>% group_by(Name, Group) %>% summarise(Group)
industry_cleaned %>% filter(Name == ''Alcoholic Beverage Production Credit'') %>% select(Group) %>% distinct()

industry_cleaned %>% select(Name, Group) %>% distinct() %>% group_by(Group) %>% count()
industry_cleaned %>% filter(Group == 'Educational Services') %>% select(Name) %>% distinct() %>% arrange(Name) #%>% as.vector() %>% dplyr::first()
```

generating model from best.formula to make predictions in Rshiny (possible fix for predict.lm not working in Rshiny)
```{r}
# income.best.formula <- readRDS('Shiny_app/data/income.best.formula.rds')
# industry.best.formula <- readRDS('Shiny_app/data/industry.best.formula.rds')
# 
# ifelse(T, income.best.formula, 0)
# 
# dummy_func <- function (df){
#   x = model.matrix(Avg.bc ~., df)[, -1]
#   dummy_bc = as.data.frame(x) %>% mutate(Avg.bc = df$Avg.bc)
#   #colnames(dummy_bc) <- str_replace_all(colnames(dummy_bc), "-|'|/| |,|�|&" , '_')
#   colnames(dummy_bc) <- str_replace_all(colnames(dummy_bc), "[-'/ ,�&()`]" , '_')
#   return(dummy_bc)
# }
# predict.lm((lm(if('income' == 'income')
# {
#     income.best.formula
# } else{
#     industry.best.formula
# }, data = dummy_func(income_cleaned_bc))
# ), newdata = user_input_df_updated, interval = 'confidence')

```

